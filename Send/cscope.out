cscope 15 $HOME/work/bhc_work/CustomProtocolDemo/Send               0000010254
	@main.cpp

1 
	~<QtGui/QAµliÿtiÚ
>

2 
	~"mašwšdow.h
"

4 
	$maš
(
¬gc
, *
¬gv
[])

6 
QAµliÿtiÚ
 
	`a
(
¬gc
, 
¬gv
);

7 
MašWšdow
 
w
;

8 
w
.
	`show
();

10  
a
.
	`exec
();

11 
	}
}

	@mainwindow.cpp

1 
	~"mašwšdow.h
"

2 
	~"ui_mašwšdow.h
"

3 
	~<zmªag”.h
>

4 
	~<z´ÙocŞ.h
>

5 
	~<QHo¡Add»ss
>

6 
	~<QFe
>

7 
	gMašWšdow
::
	$MašWšdow
(
QWidg‘
 *
·»Á
) :

8 
	`QMašWšdow
(
·»Á
),

9 
	`ui
(
Ãw
 
Ui
::
MašWšdow
)

11 
ui
->
	`£tupUi
(
this
);

12 
zm
 = 
Ãw
 
	`ZTPMªag”
(1235,
	`QHo¡Add»ss
("224.124.0.1"));

13 
	`cÚÃù
(
zm
,
	`SIGNAL
(
	`»adyR—d
()),
this
,
	`SLOT
(
	`fun
()));

14 
	}
}

15 
	gMašWšdow
::
	$fun
()

17 
ZTP´ÙocŞ
 
zp
;

18 
zm
->
	`g‘OÃZ
(
zp
);

20 
QLi¡
<
QSŒšg
> 
·¿Li¡
 = 
zp
.
	`·¿s
();

21 
i
 = 0;i< 
·¿Li¡
.
	`Ëngth
();i++)

23 
QSŒšg
 
‹xt
 = "\n"+QSŒšg::
	`numb”
(
i
)+"---"+
·¿Li¡
[i]+" : "+
zp
.
	`g‘P¬a
(paraList[i]);

24 
	`qDebug
()<<
‹xt
;

25 
ui
->
‹xtBrow£r
->
	`‹xtCursÜ
().
	`š£¹Text
(
‹xt
);

27 
	}
}

29 
	gMašWšdow
::~
	$MašWšdow
()

31 
d–‘e
 
zm
;

32 
d–‘e
 
ui
;

33 
	}
}

35 
	gMašWšdow
::
	$Ú_pushBu‰Ú_şicked
()

38 
ZTP´ÙocŞ
 
zp
;

39 
zp
.
	`addP¬a
("type","hellow");

40 
zm
->
	`S’dOÃZ
(
zp
,
	`QHo¡Add»ss
("224.124.0.1"),1235);

42 
QUdpSock‘
 
udp
;

43 
udp
.
	`bšd
(
QHo¡Add»ss
::
Any
);

44 
QFe
 
	`fe
("test.png");

45 
fe
.
	`İ’
(
QFe
::
R—dOÆy
);

48 
	`qDebug
()<<"ud°£nd†’ :"<<
udp
.
	`wr™eD©ag¿m
(
fe
.
	`»adAÎ
().
	`d©a
(),65508,
	`QHo¡Add»ss
("224.124.0.1"),3333);

49 
fe
.
	`şo£
();

58 
	}
}

60 
	gMašWšdow
::
	$Ú_pushBu‰Ú_2_şicked
()

62 
ui
->
‹xtBrow£r
->
	`ş—r
();

63 
	}
}

	@mainwindow.h

1 #iâdeà
MAINWINDOW_H


2 
	#MAINWINDOW_H


	)

4 
	~<QMašWšdow
>

5 
	~<zmªag”.h
>

6 
Çme¥aû
 
	gUi
 {

7 
şass
 
	gMašWšdow
;

10 şas 
	cMašWšdow
 : 
public
 
QMašWšdow


12 
Q_OBJECT


13 
ZTPMªag”
* 
zm
;

14 
	mpublic
:

15 
ex¶ic™
 
MašWšdow
(
QWidg‘
 *
·»Á
 = 0);

16 ~
MašWšdow
();

18 
´iv©e
 
	m¦Ùs
:

19 
Ú_pushBu‰Ú_şicked
();

21 
Ú_pushBu‰Ú_2_şicked
();

22 
fun
();

24 
	m´iv©e
:

25 
Ui
::
MašWšdow
 *
ui
;

	@ztpmanager.cpp

1 
	~"zmªag”.h
"

3 
	gZTPMªag”
::
	$ZTPMªag”
(
QHo¡Add»ss
 
ho¡
,
qušt16
 
pÜt
,

4 
QHo¡Add»ss
 
groupAdd»ss
, 
QObjeù
 *
·»Á
):

5 
	$QObjeù
(
·»Á
)

8 
_Sock‘li¡’”
.
	`bšd
(
ho¡
,
pÜt
,
QUdpSock‘
::
Sh¬eAdd»ss
);

9 if(
groupAdd»ss
.
	`toIPv4Add»ss
()>0xe0000000 && groupAddress.toIPv4Address()<0xf0000000)

11 
_Sock‘li¡’”
.
	`jošMuÉiÿ¡Group
(
groupAdd»ss
);

14 
	`cÚÃù
(&
_Sock‘li¡’”
,
	`SIGNAL
(
	`»adyR—d
()),
this
,SIGNAL(readyRead()));

15 
MTU
 = 65507;

16 
	}
}

17 
	gZTPMªag”
::
	$ZTPMªag”
(
qušt16
 
pÜt
,

18 
QHo¡Add»ss
 
groupAdd»ss
, 
QObjeù
 *
·»Á
):

19 
	$QObjeù
(
·»Á
)

21 
_Sock‘li¡’”
.
	`bšd
(
QHo¡Add»ss
::
Any
,
pÜt
,
QUdpSock‘
::
Sh¬eAdd»ss
);

22 if(
groupAdd»ss
.
	`toIPv4Add»ss
()>0xe0000000 && groupAddress.toIPv4Address()<0xf0000000)

24 
_Sock‘li¡’”
.
	`jošMuÉiÿ¡Group
(
groupAdd»ss
);

27 
	`cÚÃù
(&
_Sock‘li¡’”
,
	`SIGNAL
(
	`»adyR—d
()),
this
,SIGNAL(readyRead()));

28 
	}
}

29 
	gZTPMªag”
::
ResuÉS‹
 
ZTPMªag”
::
	$g‘OÃZ
(
ZTP´ÙocŞ
& 
z
)

31 
QHo¡Add»ss
 
»mÙeHo¡
;

32 
qušt16
 
»mÙePÜt
;

33 
QBy‹A¼ay
 
	`»cvBuff
(
_Sock‘li¡’”
.
	`³ndšgD©ag¿mSize
(),'\0');

34 
qšt64
 
³ndšgL’
 = 
_Sock‘li¡’”
.
	`»adD©ag¿m
(
»cvBuff
.
	`d©a
(),»cvBuff.
	`Ëngth
(),&
»mÙeHo¡
,&
»mÙePÜt
);

35 
qšt64
 
Ën
;

36 
	`memıy
(&
Ën
,
»cvBuff
.
	`d©a
()+6,8);

37 if(
³ndšgL’
!=
Ën
)

39 
	`qDebug
("recv ZTP dataƒrror: has data %lld bytes‡nd‡ctually„ecv %lld bytes!!\n",

40 
Ën
,
³ndšgL’
);

41  
FAILED
;

43 
z
.
	`ş—r
();

44 
z
.
	`lßd
(
»cvBuff
);

45 
z
.
	`addP¬a
("RemÙeHo¡",
»mÙeHo¡
.
	`toSŒšg
());

46 
z
.
	`addP¬a
("RemÙePÜt",
QSŒšg
::
	`numb”
(
»mÙePÜt
));

48  
SUCCESS
;

49 
	}
}

50 
	gZTPMªag”
::
ResuÉS‹
 
ZTPMªag”
::
	$wa™OÃZ
(
ZTP´ÙocŞ
& 
z
,
m£cs
)

53 
QHo¡Add»ss
 
»mÙeHo¡
;

54 
qušt16
 
»mÙePÜt
;

55 if(!
_Sock‘li¡’”
.
	`wa™FÜR—dyR—d
(
m£cs
))

57 if(
_Sock‘li¡’”
.
	`”rÜ
(è=ğ
QUdpSock‘
::
Sock‘TimeoutE¼Ü
)

58  
TIMEOUT
;

61 
	`qDebug
("Socketƒrror!!\n");

62  
FAILED
;

65 
QBy‹A¼ay
 
	`»cvBuff
(
_Sock‘li¡’”
.
	`³ndšgD©ag¿mSize
(),'\0');

66 
qšt64
 
³ndšgL’
 = 
_Sock‘li¡’”
.
	`»adD©ag¿m
(
»cvBuff
.
	`d©a
(),»cvBuff.
	`Ëngth
(),&
»mÙeHo¡
,&
»mÙePÜt
);

67 
qšt64
 
Ën
;

68 
	`memıy
(&
Ën
,
»cvBuff
.
	`d©a
()+6,8);

69 if(
³ndšgL’
!=
Ën
)

71 
	`qDebug
("recv ZTP dataƒrror: has data %lld bytes‡nd‡ctually„ecv %lld bytes!!\n",

72 
Ën
,
³ndšgL’
);

73  
FAILED
;

75 
z
.
	`ş—r
();

76 
z
.
	`lßd
(
»cvBuff
);

77 
z
.
	`addP¬a
("RemÙeHo¡",
»mÙeHo¡
.
	`toSŒšg
());

78 
z
.
	`addP¬a
("RemÙePÜt",
QSŒšg
::
	`numb”
(
»mÙePÜt
));

80  
SUCCESS
;

81 
	}
}

83 
	gZTPMªag”
::
ResuÉS‹
 
ZTPMªag”
::
	$S’dOÃZ
(
ZTP´ÙocŞ
& 
z
,cÚ¡ 
QHo¡Add»ss
 &
ho¡
,
qušt16
 
pÜt
)

85 
z
.
	`g’¬©e
();

86 
£ndL’
 = 
_Sock‘li¡’”
.
	`wr™eD©ag¿m
(
z
.
	`g‘RwaD©a
(),
ho¡
,
pÜt
);

87 if(
£ndL’
 !ğ
z
.
	`g‘RwaD©a
().
	`Ëngth
())

89 
	`qDebug
("send ZTP dataƒrror: has data %d bytes‡nd‡ctually send %d bytes!!\n",

90 
z
.
	`g‘RwaD©a
().
	`Ëngth
(),
£ndL’
);

91  
FAILED
;

93  
SUCCESS
;

94 
	}
}

	@ztpmanager.h

1 #iâdeà
ZTPMANAGER_H


2 
	#ZTPMANAGER_H


	)

3 
	~<QLi¡
>

4 
	~<QTh»ad
>

5 
	~<QHo¡Add»ss
>

6 
	~<QUdpSock‘
>

7 
	~<z´ÙocŞ.h
>

8 
	~<QD©eTime
>

9 
	~<QBy‹A¼ay
>

10 şas 
	cZTPMªag”
 : 
public
 
QObjeù


13 
Q_OBJECT


14 
QLi¡
<
QBy‹A¼ay
> 
zLi¡
;

15 
QUdpSock‘
 
	m_Sock‘li¡’”
;

16 
	mMTU
;

17 şas 
	cF¿gm’t


31 
	mpublic
:

32 
qušt16
 
id’tif›r
;

33 
qušt16
 
	mchecksum
;

34 
qušt16
 
	mäagm’t_couÁ
;

35 
qušt16
 
	mäagm’t_off£t
;

36 
qušt32
 
	mËn
;

37 
QBy‹A¼ay
 
	md©a
;

38 
QBy‹A¼ay
 
	m¿wPkg
;

39 
	m´iv©e
:

41 
qušt16
 
g’”©eChecksum
(){

42 
qušt16
 
sum
 = 0;

43 
	mi
 = 0;i<
	mËn
+12;i++)

45 if(
	mi
>15 && i <32)

47 
	msum
 +ğ
d©a
[
i
];

49  
	msum
;

51 
	mpublic
:

52 
F¿gm’t
(){}

53 
ex¶ic™
 
F¿gm’t
(cÚ¡ 
QBy‹A¼ay
& 
by‹s
)

55 
¿wPkg
 = 
by‹s
;

56 
memıy
(&
id’tif›r
,
by‹s
.
d©a
(),16);

57 
memıy
(&
checksum
,
by‹s
.
d©a
()+16,16);

58 
memıy
(&
äagm’t_couÁ
,
by‹s
.
d©a
()+32,16);

59 
memıy
(&
äagm’t_off£t
,
by‹s
.
d©a
()+48,16);

60 
memıy
(&
Ën
,
by‹s
.
d©a
()+64,32);

61 
	md©a
.
­³nd
(
by‹s
.
d©a
()+96,
Ën
);

63 
boŞ
 
isV®id
(){ 
	mchecksum
 =ğ
g’”©eChecksum
();}

64 
g’”©e
()

66 
	m¿wPkg
 = 
QBy‹A¼ay
(96,0);

67 
memıy
(
¿wPkg
.
d©a
(),&
id’tif›r
,16);

68 
memıy
(
¿wPkg
.
d©a
()+32,&
äagm’t_couÁ
,16);

69 
memıy
(
¿wPkg
.
d©a
()+48,&
äagm’t_off£t
,16);

70 
memıy
(
¿wPkg
.
d©a
()+64,&
Ën
,32);

71 
	m¿wPkg
.
­³nd
(
d©a
);

72 
	mchecksum
 = 
g’”©eChecksum
();

73 
memıy
(
¿wPkg
.
d©a
(),&
checksum
,16);

75 
boŞ
 
	mİ”©Ü
 <(cÚ¡ 
	mF¿gm’t
& 
	mäag
)

77  
	mäagm’t_off£t
 < 
	mäag
.fragment_offset;

81 
	gsigÇls
:

82 
»adyR—d
();

83 
	gpublic
:

84 
	eResuÉS‹


86 
SUCCESS
,

87 
	gTIMEOUT
,

88 
	gFAILED


90 
ex¶ic™
 
ZTPMªag”
(
QHo¡Add»ss
 
ho¡
 = QHo¡Add»ss::
Any
,
qušt16
 
pÜt
 = 0,

91 
QHo¡Add»ss
 
groupAdd»ss
 = QHo¡Add»ss::
Any
, 
QObjeù
 *
·»Á
 = 0);

92 
ex¶ic™
 
ZTPMªag”
(
qušt16
 
pÜt
,
QHo¡Add»ss
 
groupAdd»ss
 = QHo¡Add»ss::
Any
, 
QObjeù
 *
·»Á
 = 0);

93 
ResuÉS‹
 
g‘OÃZ
(
ZTP´ÙocŞ
& 
z
);

94 
ResuÉS‹
 
wa™OÃZ
(
ZTP´ÙocŞ
& 
z
,
m£cs
 = 3000);

95 
ResuÉS‹
 
	$S’dOÃZ
(
ZTP´ÙocŞ
& 
z
,cÚ¡ 
QHo¡Add»ss
& 
ho¡
,
qušt16
 
pÜt
)

97 
z
.
	`g’¬©e
();

98 
qušt16
 
id’tif›r
 = 
QD©eTime
::
	`cu¼’tMSecsSšûEpoch
()&0xffff;

99 
qušt16
 
äagm’t_couÁ
 = 
z
.
	`g‘RwaD©a
().
	`Ëngth
()/
MTU
+1;

100 
qušt16
 
äagm’t_off£t
 = 1;

101 
i
 = 0;˜< 
äagm’t_couÁ
;i++)

103 
F¿gm’t
 
äagm’t
;

104 
äagm’t
.
id’tif›r
 = identifier;

105 
äagm’t
.
äagm’t_couÁ
 = fragment_count;

106 
äagm’t
.
äagm’t_off£t
 = fragment_offset++;

107 
äagm’t
.
d©a
 = 
z
.
	`g‘RwaD©a
().
	`»move
(0,
MTU
);

108 
äagm’t
.
Ën
 = f¿gm’t.
d©a
.
	`Ëngth
();

109 
äagm’t
.
	`g’”©e
();

110 
£ndL’
 = 
_Sock‘li¡’”
.
	`wr™eD©ag¿m
(
äagm’t
.
¿wPkg
,
ho¡
,
pÜt
);

111 if(
£ndL’
 !ğ
äagm’t
.
¿wPkg
.
	`Ëngth
())

113 
	`qDebug
("send ZTP dataƒrror: has data %d bytes‡nd‡ctually send %d bytes!!\n",

114 
z
.
	`g‘RwaD©a
().
	`Ëngth
(),
£ndL’
);

115  
FAILED
;

119  
SUCCESS
;

120 
	}
}

123 
´iv©e
 
	g¦Ùs
:

124 
ÚR—d
();

	@ztpprotocol.cpp

1 
	~"z´ÙocŞ.h
"

2 
	~<QBy‹A¼ay
>

3 
	~<QDebug
>

4 
	gZTP´ÙocŞ
::
	$ZTP´ÙocŞ
(
QBy‹A¼ay
 &
by‹s
)

6 
	`lßd
(
by‹s
);

7 
	}
}

10 
	gZTP´ÙocŞ
::
	$lßd
(
QBy‹A¼ay
& 
by‹s
)

12 
pos
 = 
by‹s
.
	`šdexOf
("&head&");

13 
by‹s
.
	`»move
(
pos
,17);

14 
pos
 = 
by‹s
.
	`šdexOf
("&end&");

15 
by‹s
.
	`»move
(
pos
,5);

16 
QSŒšgLi¡
 
¡rLi¡
 = 
QSŒšg
::
	`äomUtf8
(
by‹s
.
	`d©a
(),by‹s.
	`Ëngth
()).
	`¥l™
("&|&");

17 
i
 = 0;i<
¡rLi¡
.
	`Ëngth
();i++)

19 
QSŒšgLi¡
 
subLi¡
 = 
¡rLi¡
[
i
].
	`¥l™
(":|:");

20 
QSŒšg
 
k
 = 
subLi¡
[0];

21 
QSŒšg
 
v
 = 
subLi¡
[1];

22 
m­
.
	`š£¹
(
k
,
v
);

24 
	}
}

25 
	gZTP´ÙocŞ
::
	$ş—r
()

27 
m­
.
	`ş—r
();

28 
¿wD©a
.
	`ş—r
();

29 
	}
}

31 
	gZTP´ÙocŞ
::
	$»moveP¬a
(cÚ¡ 
QSŒšg
& 
·¿Name
)

33 
m­
.
	`»move
(
·¿Name
);

34 
	}
}

36 
	gZTP´ÙocŞ
::
	$addP¬a
(cÚ¡ 
QSŒšg
& 
·¿Name
,cÚ¡ QSŒšg& 
·¿V®ue
)

38 
m­
.
	`š£¹
(
·¿Name
,
·¿V®ue
);

39 
	}
}

41 
	gZTP´ÙocŞ
::
	$g’¬©e
()

43 
QLi¡
<
QSŒšg
> 
keyLi¡
 = 
m­
.
	`keys
();

44 
¿wD©a
 = "&head&00000000";

45 
i
 = 0;i<
keyLi¡
.
	`Ëngth
();i++)

47 
¿wD©a
.
	`­³nd
("&|&");

48 
¿wD©a
.
	`­³nd
(
keyLi¡
[
i
].
	`toUtf8
());

49 
¿wD©a
.
	`­³nd
(":|:");

50 
¿wD©a
.
	`­³nd
(
m­
[
keyLi¡
[
i
]].
	`toUtf8
());

52 
¿wD©a
.
	`­³nd
("&end&");

53 
qšt64
 
Ën
 = 
¿wD©a
.
	`Ëngth
();

54 
	`memıy
(
¿wD©a
.
	`d©a
()+6,&
Ën
,8);

55 
	}
}

	@ztpprotocol.h

1 #iâdeà
ZTPPROTOCOL_H


2 
	#ZTPPROTOCOL_H


	)

3 
	~<QBy‹A¼ay
>

4 
	~<QM­
>

5 
	~<QSŒšgLi¡
>

6 
şass
 
	gQSŒšg
;

7 şas 
	cZTP´ÙocŞ


9 
	mQM­
<
	mQSŒšg
, QSŒšg> 
	mm­
;

10 
QBy‹A¼ay
 
	m¿wD©a
;

11 
	mpublic
:

12 
	$ZTP´ÙocŞ
(){}

13 
ex¶ic™
 
	`ZTP´ÙocŞ
(
QBy‹A¼ay
& 
by‹s
);

14 
QSŒšg
 
	$g‘P¬a
(cÚ¡ 
QSŒšg
& 
·¿Name
){ 
m­
[·¿Name];
	}
}

15 
addP¬a
(cÚ¡ 
QSŒšg
& 
·¿Name
,cÚ¡ QSŒšg& 
·¿V®ue
);

16 
»moveP¬a
(cÚ¡ 
QSŒšg
& 
·¿Name
);

18 
	$couÁ
()cÚ¡{ 
m­
.
	`couÁ
();
	}
}

19 
	gQLi¡
<
	gQSŒšg
> 
	$·¿s
(){ 
m­
.
	`keys
();
	}
}

21 
	gpublic
:

22 
g’¬©e
();

23 
	gQBy‹A¼ay
& 
	$g‘RwaD©a
()cÚ¡{ 
¿wD©a
;
	}
}

24 
lßd
(
QBy‹A¼ay
& 
by‹s
);

25 
ş—r
();

	@
1
.
1
/usr/include
7
95
main.cpp
mainwindow.cpp
mainwindow.h
ztpmanager.cpp
ztpmanager.h
ztpprotocol.cpp
ztpprotocol.h
